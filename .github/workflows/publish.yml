name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-python:
    name: Build Python distribution
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Store distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  build-typescript:
    name: Build TypeScript packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build @cascadeflow/ml
        run: |
          cd packages/ml
          pnpm build

      - name: Build @cascadeflow/core
        run: |
          cd packages/core
          pnpm build

      - name: Build @cascadeflow/n8n-nodes-cascadeflow
        run: |
          cd packages/integrations/n8n
          pnpm build

      - name: Build @cascadeflow/langchain-cascadeflow
        run: |
          cd packages/langchain-cascadeflow
          pnpm build

      - name: Build @cascadeflow/vercel-ai
        run: |
          cd packages/integrations/vercel-ai
          pnpm build

      - name: Build @cascadeflow/paygentic
        run: |
          cd packages/integrations/paygentic
          pnpm build

      - name: Store @cascadeflow/core package
        uses: actions/upload-artifact@v4
        with:
          name: npm-cascadeflow-core
          path: packages/core/

      - name: Store @cascadeflow/ml package
        uses: actions/upload-artifact@v4
        with:
          name: npm-cascadeflow-ml
          path: packages/ml/

      - name: Store @cascadeflow/n8n-nodes-cascadeflow package
        uses: actions/upload-artifact@v4
        with:
          name: npm-cascadeflow-n8n-nodes-cascadeflow
          path: packages/integrations/n8n/

      - name: Store @cascadeflow/langchain-cascadeflow package
        uses: actions/upload-artifact@v4
        with:
          name: npm-cascadeflow-langchain-cascadeflow
          path: packages/langchain-cascadeflow/

      - name: Store @cascadeflow/vercel-ai package
        uses: actions/upload-artifact@v4
        with:
          name: npm-cascadeflow-vercel-ai
          path: packages/integrations/vercel-ai/

      - name: Store @cascadeflow/paygentic package
        uses: actions/upload-artifact@v4
        with:
          name: npm-cascadeflow-paygentic
          path: packages/integrations/paygentic/

  publish-to-pypi:
    name: Publish to PyPI
    needs: build-python
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/cascadeflow
    permissions:
      id-token: write  # For trusted publishing

    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

  publish-to-npm:
    name: Publish to npm
    needs: build-typescript
    runs-on: ubuntu-latest
    environment:
      name: npm
      url: https://www.npmjs.com/package/@cascadeflow/core
    permissions:
      contents: read
      id-token: write  # Required for npm provenance

    steps:
      - name: Download @cascadeflow/core
        uses: actions/download-artifact@v4
        with:
          name: npm-cascadeflow-core
          path: packages/core/

      - name: Download @cascadeflow/ml
        uses: actions/download-artifact@v4
        with:
          name: npm-cascadeflow-ml
          path: packages/ml/

      - name: Download @cascadeflow/n8n-nodes-cascadeflow
        uses: actions/download-artifact@v4
        with:
          name: npm-cascadeflow-n8n-nodes-cascadeflow
          path: packages/integrations/n8n/

      - name: Download @cascadeflow/langchain-cascadeflow
        uses: actions/download-artifact@v4
        with:
          name: npm-cascadeflow-langchain-cascadeflow
          path: packages/langchain-cascadeflow/

      - name: Download @cascadeflow/vercel-ai
        uses: actions/download-artifact@v4
        with:
          name: npm-cascadeflow-vercel-ai
          path: packages/integrations/vercel-ai/

      - name: Download @cascadeflow/paygentic
        uses: actions/download-artifact@v4
        with:
          name: npm-cascadeflow-paygentic
          path: packages/integrations/paygentic/

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # Update npm for OIDC trusted publishing support
      - name: Update npm to latest
        run: npm install -g npm@latest

      # pnpm pack resolves workspace: protocol refs, then npm publish uses OIDC
      - name: Publish @cascadeflow/ml
        run: |
          set -euo pipefail
          cd packages/ml
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${PACKAGE_VERSION} already exists on npm, skipping."
            exit 0
          fi
          TARBALL=$(pnpm pack --pack-destination .)
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @cascadeflow/core
        run: |
          set -euo pipefail
          cd packages/core
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${PACKAGE_VERSION} already exists on npm, skipping."
            exit 0
          fi
          TARBALL=$(pnpm pack --pack-destination .)
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @cascadeflow/n8n-nodes-cascadeflow
        run: |
          set -euo pipefail
          cd packages/integrations/n8n
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${PACKAGE_VERSION} already exists on npm, skipping."
            exit 0
          fi
          TARBALL=$(pnpm pack --pack-destination .)
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @cascadeflow/langchain
        run: |
          set -euo pipefail
          cd packages/langchain-cascadeflow
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${PACKAGE_VERSION} already exists on npm, skipping."
            exit 0
          fi
          TARBALL=$(pnpm pack --pack-destination .)
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @cascadeflow/vercel-ai
        run: |
          set -euo pipefail
          cd packages/integrations/vercel-ai
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${PACKAGE_VERSION} already exists on npm, skipping."
            exit 0
          fi
          TARBALL=$(pnpm pack --pack-destination .)
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @cascadeflow/paygentic
        run: |
          set -euo pipefail
          cd packages/integrations/paygentic
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${PACKAGE_VERSION} already exists on npm, skipping."
            exit 0
          fi
          TARBALL=$(pnpm pack --pack-destination .)
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-to-testpypi:
    name: Publish to TestPyPI
    needs: build-python
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Only on manual trigger
    environment:
      name: testpypi
      url: https://test.pypi.org/p/cascadeflow
    permissions:
      id-token: write  # For trusted publishing

    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          skip-existing: true
